<?php
require("include/definitions.php");
if(isset($_POST['device_type']))
	$device_type = $_POST['device_type'];
else
	$device_type = 'switch_bud';

if(isset($_POST['dodaj']))
{
	echo"dodaj";
	echo($_POST['device_type']);
	$device = array(
		'dev_id' => $_POST['dev_id'],
		'other_name' => $_POST['other_name'],
		'gateway' => $_POST['gateway'],
		'opis' => $_POST['opis'],
		'device_type' => $_POST['device_type'],
		'parent_port' => $_POST['parent_port'],
		'parent_device' => $_POST['parent_device'],
		'osiedle' => $_POST['osiedle'],
		'blok' => $_POST['blok'],
		'klatka' => $_POST['klatka'],
		'uplink_mc_sn' => $_POST['uplink_mc_sn']);
	$ip = array();
	foreach($_POST as $key=>$dana)
	{
		if(substr($key, 0, 3)=="_ip")
		{
			$ip[substr($key, 3)]['ip'] = $dana;
			if(substr($key, 3)==1)
				$ip[substr($key, 3)]['main'] = 1;
		}
		else if(substr($key, 0, 8)=="_podsiec")
			$ip[substr($key, 8)]['podsiec'] = $dana;
		else if(substr($key, 0, 5)=="_vlan")
			$ip[substr($key, 5)]['vlan'] = $dana;
	}
	$obj = new Device();
	if(! $obj->sprawdzIp($ip) ||! $obj->sprawdzDevice($device))
		exit();
	$device['ip'] = $ip;
	switch($_POST['device_type'])
	{
	case 'switch_rejon':
		$switch = new Switch_rejon();
		$sql = $switch->connect();
		mysql_query("SET AUTOCOMMIT=0", $sql);
		mysql_query("BEGIN", $sql);
		$switch->dodaj($device, 
			$_POST['sn'], 
			$_POST['model'], 
			$_POST['producent'], 
			$_POST['port_count'], 
			$_POST['opis_historii']);
		if($switch->device != -1)
		{
			mysql_query("COMMIT", $sql) or die(mysql_error());
			Daddy::error("Dodano przełącznik rejonowy.");
		}
		else
		{
			mysql_query("ROLLBACK", $sql) or die(mysql_error());
			Daddy::error("Nie dodano przełącznika!");
		}
	break;
	case 'switch_bud':
		$switch = new Switch_bud();
		$sql = $switch->connect();
		mysql_query("SET AUTOCOMMIT=0", $sql);
		mysql_query("BEGIN", $sql);
		$switch->dodaj($device, 
			$_POST['sn'], 
			$_POST['model'], 
			$_POST['producent'],
			$_POST['typ'],
			$_POST['port_count'], 
			$_POST['vlan'], 
			$_POST['opis_historii']);
		if($switch->device != -1)
		{
			mysql_query("COMMIT", $sql) or die(mysql_error());
			Daddy::error("Dodano przełącznik.");
		}
		else
		{
			mysql_query("ROLLBACK", $sql) or die(mysql_error());
			Daddy::error("Nie dodano przełącznika!");
		}
	break;
	case 'kamera':
		echo "kamere";
		$kamera = new Kamera();
		$sql = $kamera->connect();
		mysql_query("SET AUTOCOMMIT=0", $sql);
		mysql_query("BEGIN", $sql);
		$kamera->dodaj($device, 
			$_POST['sn'], 
			$_POST['model'], 
			$_POST['producent'],
			$_POST['nazwa'],
			$_POST['opis_historii']);
		if($kamera->device != -1)
		{
			mysql_query("COMMIT", $sql) or die(mysql_error());
			Daddy::error("Dodano kamerę.");
		}
		else
		{
			mysql_query("ROLLBACK", $sql) or die(mysql_error());
			Daddy::error("Nie dodano kamery!");
		}
	break;
	case 'serwer':
		$server = new Server();
		$sql = $serwer->connect();
		mysql_query("SET AUTOCOMMIT=0", $sql);
		mysql_query("BEGIN", $sql);
		$server->dodaj($device, 
			$_POST['sn'], 
			$_POST['model'], 
			$_POST['producent'], 
			$_POST['hd1'], 
			$_POST['hd2'], 
			$_POST['hd3'], 
			$_POST['hd4'], 
			$_POST['opis_historii']);
		if($server->device != -1)
		{
			mysql_query("COMMIT", $sql) or die(mysql_error());
			Daddy::error("Dodano serwer.");
		}
		else
		{
			mysql_query("ROLLBACK", $sql) or die(mysql_error());
			Daddy::error("Nie dodano serwera!");
		}
	break;
	case 'bramka_voip':
		$bramka = new Bramka_voip();
		$sql = $bramka->connect();
		mysql_query("SET AUTOCOMMIT=0", $sql);
		mysql_query("BEGIN", $sql);
		$bramka->dodaj($device, 
			$_POST['sn'], 
			$_POST['model'], 
			$_POST['producent'], 
			$_POST['port_count'],
			$_POST['opis_historii']);
		if($bramka->device != -1)
		{
			mysql_query("COMMIT", $sql) or die(mysql_error());
			Daddy::error("Dodano bramkę VoIP.");
		}
		else
		{
			mysql_query("ROLLBACK", $sql) or die(mysql_error());
			Daddy::error("Nie dodano bramki VoIP!");
		}
	break;
	case 'router':
		$router = new Router();
		$sql = $router->connect();
		mysql_query("SET AUTOCOMMIT=0", $sql);
		mysql_query("BEGIN", $sql);
		$router->dodaj($device, 
			$_POST['sn'], 
			$_POST['model'], 
			$_POST['producent'],
			$_POST['opis_historii']);
		if($router->device != -1)
		{
			mysql_query("COMMIT", $sql) or die(mysql_error());
			Daddy::error("Dodano router.");
		}
		else
		{
			mysql_query("ROLLBACK", $sql) or die(mysql_error());
			Daddy::error("Nie dodano routera!");
		}
	break;
	case 'host':
		$host = new Host();
		$sql = $host->connect();
		mysql_query("SET AUTOCOMMIT=0", $sql);
		mysql_query("BEGIN", $sql);
		$host->dodaj($device, 
			$_POST['nr_mieszkania']);
		if($host->device != -1)
		{
			mysql_query("COMMIT", $sql) or die(mysql_error());
			Daddy::error("Dodano hosta.");
		}
		else
		{
			mysql_query("ROLLBACK", $sql) or die(mysql_error());
			Daddy::error("Nie dodano hosta!");
		}
	break;
	}
}
else
{
	//generujemy listę urządzeń
	$zapytanie = "SELECT Device.dev_id, Adres_ip.ip, Device.device_type, Device.other_name, Lokalizacja.osiedle, Lokalizacja.nr_bloku, Lokalizacja.klatka FROM Device, Lokalizacja, Adres_ip WHERE Device.lokalizacja = Lokalizacja.id AND Adres_ip.device=Device.dev_id AND Adres_ip.main='1' AND (Device.device_type='switch_rejon' OR Device.device_type='switch_bud' OR Device.device_type='router' OR Device.device_type='switch_centralny') ORDER BY Lokalizacja.osiedle, Lokalizacja.nr_bloku, Lokalizacja.klatka";
	$obj = new Device();
	$sql = $obj->connect();
	$wynik = $obj->query($zapytanie);
	$opcje = array();
	for($i=0; $i < count($wynik); $i++)
	{
		$opcje[$i]['dev_id'] = $wynik[$i]['dev_id'];
		if($wynik[$i]['other_name'])
			$opcje[$i]['nazwa'] = $wynik[$i]['other_name']." - ".$wynik[$i]['ip'];
		else if($wynik[$i]['device_type']=='switch_rejon')
			$opcje[$i]['nazwa'] = $wynik[$i]['osiedle']. $wynik[$i]['nr_bloku'].$wynik[$i]['klatka']." - ".$wynik[$i]['ip']."(R)";
		else
			$opcje[$i]['nazwa'] = $wynik[$i]['osiedle']. $wynik[$i]['nr_bloku'].$wynik[$i]['klatka']." - ".$wynik[$i]['ip'];
	}
	require('formularz_naglowek.php');
	require('formularz_device.php');
	switch ($device_type)
	{
	case 'switch_rejon':
		require('formularz_switch_rejon.php');
		break;
	case 'switch_bud':
		require('formularz_switch_bud.php');
		break;
	case 'kamera':
		require('formularz_kamera.php');
		break;
	case 'serwer':
		require('formularz_serwer.php');
		break;
	case 'bramka_voip':
		require('formularz_bramka_voip.php');
		break;
	case 'host':
		require('formularz_host.php');
		break;
	case 'router':
		require('formularz_router.php');
		break;
}
	require('formularz_stopka.php');
}
?>
